---
import fs from 'node:fs';
import path from 'node:path';
import { Code } from 'astro:components';

interface Props {
  file: string;
  lines?: string; // e.g. "1-10", "5,7,9"
  lang?: string;
  title?: string;
}

const { file, lines, lang = 'python', title } = Astro.props;

// Resolve path relative to the project root (one level up from website)
// Astro.site or import.meta.url might be useful, but process.cwd() in Astro usually points to the project root where `astro` is run.
// If `astro dev` is run in `website/`, then process.cwd() is `website/`.
// So we need to go up one level.

const projectRoot = path.resolve(process.cwd(), '..');
const filePath = path.resolve(projectRoot, file);

if (!fs.existsSync(filePath)) {
  throw new Error(`File not found: ${filePath}`);
}

const fileContent = fs.readFileSync(filePath, 'utf-8');
const allLines = fileContent.split('\n');

let selectedContent = fileContent;

if (lines) {
  const ranges = lines.split(',').map(s => s.trim());
  const selectedLines: string[] = [];
  
  // Simple parser for "1-5" or "3"
  // Note: User lines are usually 1-based.
  
  // We might want to support multiple ranges, but let's keep it simple first.
  // Actually, let's just pick the lines.
  
  // If we just want to extract a block, we can filter.
  // But usually we want to preserve indentation of the block? 
  // If we extract lines 5-10, and they are indented, we might want to dedent?
  // Let's leave them as is for now.

  const lineIndices = new Set<number>();
  
  ranges.forEach(range => {
    if (range.includes('-')) {
      const [start, end] = range.split('-').map(Number);
      for (let i = start; i <= end; i++) {
        lineIndices.add(i - 1); // 0-based index
      }
    } else {
      lineIndices.add(Number(range) - 1);
    }
  });
  
  selectedContent = allLines
    .filter((_, index) => lineIndices.has(index))
    .join('\n');
}
---

<div class="code-snippet">
  {title && <div class="code-title">{title}</div>}
  <Code code={selectedContent} lang={lang} theme="catppuccin-latte" />
</div>
